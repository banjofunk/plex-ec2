service: plex-ec2-resources
provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-west-2'}
custom:
  scripts:
    hooks:
      'before:deploy:deploy': yarn upload-templates
plugins:
  - serverless-pseudo-parameters
  - serverless-plugin-scripts
package:
  exclude:
    - node_modules/**
resources:
  Conditions:
    CreateResources: 
      Fn::Equals:
        - ${ssm:/plex-ec2/create-resources, 'true'}
        - 'true'
  Resources:
    RestApi:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Name: plexEc2Api
        Description: Plex Ec2 API Gateway
    PlexMovieBucket:
      Type: AWS::S3::Bucket
      Condition: CreateResources
      DeletionPolicy: Retain
      Properties:
        BucketName: plex-movie
    CreateResourcesParameter:
      Type: AWS::SSM::Parameter
      DeletionPolicy: Retain
      Properties:
        Name: /plex-ec2/create-resources
        Type: String
        Value: 'false'
        Description: plex-ec2 resource creation status
  Outputs:
    RestApiRootResourceId:
      Description: Plex Ec2 - api gateway resource id
      Value:
        Fn::GetAtt: 
          - RestApi
          - RootResourceId
      Export:
        Name: "#{AWS::StackName}-RestApiRootResourceId"
    RestApiId:
      Description: Plex Ec2 - api gateway rest api id
      Value:
        Ref: RestApi
      Export:
        Name: "#{AWS::StackName}-RestApiId"
    RestApiEndpoint:
      Description: Plex Ec2 - api gateway rest api endpoint
      Value: "https://#{RestApi}.execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}"
      Export:
        Name: "#{AWS::StackName}-RestApiEndpoint"
